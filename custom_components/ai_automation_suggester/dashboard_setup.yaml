###############################################################################
# AI Automation Suggester - Dashboard Template (v2.2 PRO)
# 
# Dependencies: 
# - HACS: Mushroom Cards (for chips and buttons)
# - HACS: AI Automation Suggester Integration
# - At ai_automations.yaml er inkluderet i din configuration.yaml
#
# Changelog v2.2:
# - Opdateret til nye entity_ids (sensor.ai_suggester_...)
# - Tilf√∏jet det interaktive JS-kort som center-hub.
# - Dynamisk underst√∏ttelse af flere AI-udbydere samtidigt.
###############################################################################

type: vertical-stack
cards:
  # --- 1. STATUS & MODEL INFO (DYNAMISK OVERBLIK) ---
  - type: custom:mushroom-chips-card
    alignment: start
    chips:
      # Denne chip finder selv din f√∏rste aktive AI og viser dens forslag
      - type: template
        content: >
          {% set sensor = states.sensor | selectattr('entity_id', 'search', '^sensor\.ai_suggester_.*_suggestions$') | map(attribute='entity_id') | first | default('none') %}
          {% if sensor != 'none' %}
            Forslag: {{ states(sensor) }}
          {% else %}
            Ingen AI fundet
          {% endif %}
        icon: mdi:robot-happy-outline
        icon_color: "{{ 'orange' if states(entity) | int > 0 else 'green' }}"
        tap_action:
          action: more-info
      
      # Chip til Model-navn
      - type: template
        content: >
          {% set sensor = states.sensor | selectattr('entity_id', 'search', '^sensor\.ai_suggester_.*_model$') | map(attribute='entity_id') | first | default('none') %}
          {{ states(sensor) if sensor != 'none' else 'N/A' }}
        icon: mdi:brain

  # --- 2. DET INTERAKTIVE JS-KORT (Accept / Ignore Hub) ---
  - type: custom:ai-automation-suggester-card
    title: "AI Quick Actions"
    # TIP: Klik p√• 'Rediger' i UI for at v√¶lge din udbyder i dropdown-menuen.

  # --- 3. AKTIVE FORSLAG MED YAML (Fra v2.0) ---
  - type: markdown
    content: >
      {% set sensors = states.sensor | selectattr('entity_id', 'search', '^sensor\.ai_suggester_.*_suggestions$') | list %}
      # ü§ñ Aktive AI Forslag
      
      {% for s in sensors %}
        {% set suggestions = state_attr(s.entity_id, 'suggestions_list') %}
        {% set provider = state_attr(s.entity_id, 'provider') %}
        
        {% if suggestions and suggestions | length > 0 %}
          ### üß† Fra: {{ provider }}
          {% for item in suggestions %}
          **{{ loop.index }}. {{ item.title }}** (`{{ item.type | upper }}`)
          
          {{ item.description }}
          
          <details>
          <summary>üîç Se YAML kode (Klik for at folde ud)</summary>
          
          ```yaml
          {{ item.yaml }}
          ```
          </details>
          ---
          {% endfor %}
        {% endif %}
      {% endfor %}
      
      {% if sensors | length == 0 %}
        _Ingen forslag tilg√¶ngelige. Tryk p√• knappen herunder for at starte en analyse._
      {% endif %}

  # --- 4. SYSTEM KONTROL ---
  - type: entities
    title: System Kontrol
    show_header_toggle: false
    entities:
      # Dynamisk liste over fejlbeskeder
      - type: custom:auto-entities
        card:
          type: entities
        filter:
          include:
            - entity_id: "sensor.ai_suggester_*_last_error"
              options:
                name: "Seneste Fejl"
        show_empty: false
        
      # Antal enheder analyseret (fra den f√∏rste udbyder)
      - type: attribute
        entity: sensor.ai_suggester_google_suggestions
        attribute: entities_processed_count
        name: Enheder Analyseret
        icon: mdi:chart-bubble
    footer:
      type: buttons
      entities:
        - action_name: Start Ny Analyse
          service: ai_automation_suggester.generate_suggestions
          icon: mdi:refresh

  # --- 5. FORSLAGSHISTORIK (Sidste 10 - Fra v2.0) ---
  - type: markdown
    content: >
      # üìö Forslagshistorik
      {% set sensors = states.sensor | selectattr('entity_id', 'search', '^sensor\.ai_suggester_.*_suggestions$') | list %}
      
      {% for s in sensors %}
        {% set history = state_attr(s.entity_id, 'history') %}
        {% if history and history | length > 0 %}
          ### üïí Historik fra {{ state_attr(s.entity_id, 'provider') }}
          {% for item in history[:10] %}
          **{{ item.timestamp[:10] }} - {{ item.title }}**
          
          <details>
          <summary>üîç Se den gamle YAML kode</summary>
          
          ```yaml
          {{ item.yaml }}
          ```
          </details>
          {% endfor %}
          ---
        {% endif %}
      {% endfor %}

  # --- 6. VEDLIGEHOLDELSE ---
  - type: button
    name: Ryd Al AI Historik
    icon: mdi:delete-sweep
    tap_action:
      action: call-service
      service: ai_automation_suggester.clear_suggestion_history
      confirmation:
        text: Er du sikker p√•, at du vil slette hele historikken?
