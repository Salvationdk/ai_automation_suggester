###############################################################################
# AI Automation Suggester - Advanced Dashboard v2.0
# 
# Dette dashboard kr√¶ver:
# - Mushroom Cards (valgfrit, for chips)
# - At ai_automations.yaml er inkluderet i din configuration.yaml
###############################################################################

type: vertical-stack
cards:
  # --- 1. STATUS CHIPS ---
  - type: custom:mushroom-chips-card
    alignment: start
    chips:
      - type: template
        entity: sensor.ai_automation_suggestions_google
        icon: mdi:robot-confused-outline
        icon_color: >
          {% if is_state('sensor.ai_automation_suggestions_google', 'New Suggestions Available') %}
            yellow
          {% else %}
            green
          {% endif %}
        content: "Forslag: {{ states('sensor.ai_automation_suggestions_google') }}"
      - type: template
        entity: sensor.ai_model_in_use_google
        icon: mdi:brain
        content: "{{ states('sensor.ai_model_in_use_google') }}"

  # --- 2. AKTIVE FORSLAG ---
  - type: markdown
    content: >
      {% set suggestions = state_attr('sensor.ai_automation_suggestions_google', 'suggestions_list') %}
      # ü§ñ Aktive AI Forslag
      
      {% if suggestions and suggestions is iterable and suggestions | length > 0 %}
        {% for item in suggestions %}
        ### {{ loop.index }}. {{ item.title }}
        **Type:** `{{ item.type | upper }}`
        
        {{ item.description }}
        
        <details>
        <summary>üîç Se YAML kode</summary>
        
        ```yaml
        {{ item.yaml }}
        ```
        </details>
        ---
        {% endfor %}
      {% else %}
        _Ingen nye forslag tilg√¶ngelige. Tryk p√• knappen herunder for at starte en analyse._
      {% endif %}

  # --- 3. HANDLINGER (GEM FORSLAG) ---
  # Da standard knapper ikke kan l√¶se ID'er dynamisk, bruger vi en entities liste her
  - type: entities
    title: "Gem forslag til fil"
    show_header_toggle: false
    entities:
      - type: section
        label: "V√¶lg et forslag for at gemme det"
      # Vi viser de 3 nyeste forslag som knapper
      - entity: sensor.ai_automation_suggestions_google
        name: "Gem Forslag #1"
        icon: mdi:content-save-move
        tap_action:
          action: call-service
          service: ai_automation_suggester.save_suggestion
          service_data:
            # Vi bruger en fast ID-reference eller lader koordinatoren tage den nyeste
            suggestion_id: "latest_1" 
      - entity: sensor.ai_automation_suggestions_google
        name: "Gem Forslag #2"
        icon: mdi:content-save-move
        tap_action:
          action: call-service
          service: ai_automation_suggester.save_suggestion
          service_data:
            suggestion_id: "latest_2"

  # --- 4. SYSTEM KONTROL ---
  - type: entities
    title: System Kontrol
    show_header_toggle: false
    entities:
      - entity: sensor.ai_last_error_message_google
        name: Seneste Fejl
      - type: attribute
        entity: sensor.ai_automation_suggestions_google
        attribute: entities_processed_count
        name: Enheder Analyseret
        icon: mdi:chart-bubble
    footer:
      type: buttons
      entities:
        - action_name: Start Ny Analyse
          service: ai_automation_suggester.generate_suggestions
          icon: mdi:refresh

  # --- 5. HISTORIK ---
  - type: markdown
    content: >
      # üìö Forslagshistorik (Sidste 5)
      {% set history = state_attr('sensor.ai_automation_suggestions_google', 'history') %}
      
      {% if history and history is iterable and history | length > 0 %}
        {% for item in history[:5] %}
        ### üïí {{ item.timestamp[:10] }} - {{ item.title }}
        {{ item.description }}
        
        <details>
        <summary>üîç Se gammel kode</summary>
        
        ```yaml
        {{ item.yaml }}
        ```
        </details>
        ---
        {% endfor %}
      {% else %}
        _Historikken er tom._
      {% endif %}

  # --- 6. VEDLIGEHOLDELSE ---
  - type: button
    name: Ryd Al AI Historik
    icon: mdi:delete-sweep
    tap_action:
      action: call-service
      service: ai_automation_suggester.clear_suggestion_history
      confirmation:
        text: Er du sikker p√•, at du vil slette hele historikken?
