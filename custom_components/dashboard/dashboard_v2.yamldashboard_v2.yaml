###############################################################################
# AI Automation Suggester - Advanced Dashboard v2.0
# 
# Dette dashboard inkluderer:
# - Status overblik (Chips)
# - Aktive forslag med "Gem"-knapper (Direkte til ai_automations.yaml)
# - Forslagshistorik (Se de sidste 100 forslag)
# - Vedligeholdelse (Ryd historik)
###############################################################################

type: vertical-stack
cards:
  # --- 1. STATUS & MODEL INFO ---
  - type: custom:mushroom-chips-card
    alignment: start
    chips:
      - type: template
        entity: sensor.ai_automation_suggestions_google
        icon: mdi:robot-confused-outline
        icon_color: "{{ 'yellow' if states(entity) == 'New Suggestions Available' else 'green' }}"
        content: "{{ states(entity) | replace('_', ' ') }}"
      - type: template
        entity: sensor.ai_model_in_use_google
        icon: mdi:brain
        content: "{{ states(entity) }}"
      - type: template
        entity: sensor.ai_provider_status_google
        icon: mdi:lan-check
        icon_color: "{{ 'green' if is_state(entity,'connected') else 'red' }}"
        content: "Status: {{ states(entity) }}"

  # --- 2. AKTIVE FORSLAG (MED GEM-FUNKTION) ---
  - type: markdown
    content: >
      {% set suggestions = state_attr('sensor.ai_automation_suggestions_google', 'suggestions_list') %}
      # ü§ñ Aktive AI Forslag ({{ suggestions | length if suggestions else 0 }} stk)
      
      {% if suggestions and suggestions is iterable and suggestions | length > 0 %}
        {% for item in suggestions %}
        ### {{ loop.index }}. {{ item.title }}
        **Type:** `{{ item.type | upper }}`
        
        {{ item.description }}
        
        {% if item.yaml %}
        <details>
        <summary>üîç Se YAML kode</summary>
        
        ```yaml
        {{ item.yaml }}
        ```
        </details>
        {% endif %}
        ---
        {% endfor %}
      {% else %}
        _Ingen nye forslag. Tryk p√• knappen herunder for at starte en analyse._
      {% endif %}

  - type: horizontal-stack
    cards:
      {% set suggestions = state_attr('sensor.ai_automation_suggestions_google', 'suggestions_list') %}
      {% if suggestions and suggestions is iterable %}
        {% for item in suggestions[:3] %}
        - type: button
          name: "Gem #{{ loop.index }}"
          icon: mdi:content-save-move
          tap_action:
            action: call-service
            service: ai_automation_suggester.save_suggestion
            service_data:
              suggestion_id: "{{ item.suggestion_id }}"
        {% endfor %}
      {% endif %}

  # --- 3. SYSTEM KONTROL ---
  - type: entities
    title: System Kontrol
    show_header_toggle: false
    entities:
      - entity: sensor.last_error_message_google
        name: Seneste Fejl
      - type: attribute
        entity: sensor.ai_automation_suggestions_google
        attribute: entities_processed_count
        name: Enheder Analyseret
        icon: mdi:chart-bubble
    footer:
      type: buttons
      entities:
        - action_name: Start Ny Analyse
          service: ai_automation_suggester.generate_suggestions
          icon: mdi:refresh

  # --- 4. HISTORIK (GENDAN GAMLE FORSLAG) ---
  - type: markdown
    content: >
      # üìö Forslagshistorik (Sidste 10)
      {% set history = state_attr('sensor.ai_automation_suggestions_google', 'history') %}
      
      {% if history and history is iterable and history | length > 0 %}
        {% for item in history[:10] %}
        ### üïí {{ item.timestamp[:10] }} - {{ item.title }}
        {{ item.description }}
        
        <details>
        <summary>üîç Se den gamle YAML kode</summary>
        
        ```yaml
        {{ item.yaml }}
        ```
        </details>
        ---
        {% endfor %}
      {% else %}
        _Historikken er tom._
      {% endif %}

  # --- 5. VEDLIGEHOLDELSE ---
  - type: button
    name: Ryd Al AI Historik
    icon: mdi:delete-sweep
    tap_action:
      action: call-service
      service: ai_automation_suggester.clear_suggestion_history
      confirmation:
        text: Er du sikker p√•, at du vil slette hele historikken?
