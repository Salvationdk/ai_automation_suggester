###############################################################################
# AI Automation Suggester - Ultra-Automatic Dashboard v2.2
# 
# FUNKTIONER:
# - Finder selv alle aktive AI-instanser (Google, OpenAI, Ollama, etc.)
# - Viser aktive forslag for hver udbyder med YAML-fold-ud.
# - Viser historik for hver udbyder.
# - Inkluderer det interaktive JS-kort til hurtige handlinger.
###############################################################################

type: vertical-stack
cards:
  # --- 1. HOVED HUB (JS-KORTET) ---
  # Dette kort samler automatisk ALLE forslag fra ALLE udbydere i √©n liste.
  - type: custom:ai-automation-suggester-card
    title: "AI Interactive Hub"

  # --- 2. DYNAMISK STATUS OVERBLIK ---
  - type: custom:mushroom-chips-card
    alignment: center
    chips:
      - type: template
        # Denne loop finder alle status-sensorer og viser dem som chips
        content: >
          {% set providers = states.sensor 
            | selectattr('entity_id', 'search', '^sensor\.ai_suggester_.*_status$') 
            | list %}
          {% for p in providers %}
            {{ state_attr(p.entity_id, 'friendly_name').split('(')[1].split(')')[0] }}: {{ p.state }}{% if not loop.last %} | {% endif %}
          {% endfor %}
        icon: mdi:robot-check

  # --- 3. AKTIVE FORSLAG (Loop gennem alle udbydere) ---
  - type: markdown
    content: >
      {% set suggestion_sensors = states.sensor 
        | selectattr('entity_id', 'search', '^sensor\.ai_suggester_.*_suggestions$') 
        | list %}
      
      # ü§ñ Aktive AI Forslag
      
      {% for sensor in suggestion_sensors %}
        {% set provider = state_attr(sensor.entity_id, 'provider') %}
        {% set suggestions = state_attr(sensor.entity_id, 'suggestions_list') %}
        
        ## üß† Udbyder: {{ provider }}
        {% if suggestions and suggestions | length > 0 %}
          {% for item in suggestions %}
          ### {{ loop.index }}. {{ item.title }}
          **Type:** `{{ item.type | upper }}`
          
          {{ item.description }}
          
          <details>
          <summary>üîç Se YAML kode</summary>
          
          ```yaml
          {{ item.yaml }}
          ```
          </details>
          {% endfor %}
        {% else %}
          _Ingen aktive forslag fra {{ provider }}._
        {% endif %}
        ---
      {% endfor %}

  # --- 4. MANUELLE HANDLINGER (DYNAMISK LISTE) ---
  - type: custom:auto-entities
    card:
      type: entities
      title: "Hurtig Gem (Backup)"
      show_header_toggle: false
    filter:
      include:
        - entity_id: "sensor.ai_suggester_*_suggestions"
          options:
            name: "Gem Nyeste Forslag"
            icon: mdi:content-save-move
            tap_action:
              action: call-service
              service: ai_automation_suggester.save_suggestion
              service_data:
                suggestion_id: "latest_1"
    show_empty: false

  # --- 5. HISTORIK (Loop gennem alle udbydere) ---
  - type: markdown
    content: >
      {% set suggestion_sensors = states.sensor 
        | selectattr('entity_id', 'search', '^sensor\.ai_suggester_.*_suggestions$') 
        | list %}
      
      # üìö Forslagshistorik (Sidste 3 pr. udbyder)
      
      {% for sensor in suggestion_sensors %}
        {% set provider = state_attr(sensor.entity_id, 'provider') %}
        {% set history = state_attr(sensor.entity_id, 'history') %}
        
        {% if history and history | length > 0 %}
          ### üïí Historik fra {{ provider }}
          {% for item in history[:3] %}
          **{{ item.timestamp[:16] }}**: {{ item.title }}
          <details>
          <summary>Se kode</summary>
          ```yaml
          {{ item.yaml }}
          ```
          </details>
          {% endfor %}
          ---
        {% endif %}
      {% endfor %}

  # --- 6. SYSTEM KONTROL ---
  - type: entities
    title: Global AI Kontrol
    entities:
      - type: buttons
        entities:
          - action_name: Start Analyse
            service: ai_automation_suggester.generate_suggestions
            icon: mdi:refresh
          - action_name: Ryd Al Historik
            service: ai_automation_suggester.clear_suggestion_history
            icon: mdi:delete-sweep
