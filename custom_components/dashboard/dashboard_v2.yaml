###############################################################################
# AI Automation Suggester - Universal Dashboard v2.2
# 
# Dette dashboard finder selv din AI-udbyder (Google, OpenAI, Ollama osv.)
# s√• l√¶nge integrationen er installeret korrekt.
###############################################################################

type: vertical-stack
cards:
  # --- 1. DET INTERAKTIVE AI KORT ---
  # Dette kort bruger vi til at se, acceptere eller afvise forslag.
  # Klik p√• "Rediger" i UI for at v√¶lge din specifikke udbyder i dropdown-menuen.
  - type: custom:ai-automation-suggester-card
    title: "AI Automation Hub"

  # --- 2. DYNAMISK STATUS & INFORMATION ---
  - type: markdown
    content: >
      {% set suggestions_sensor = states.sensor 
        | selectattr('entity_id', 'search', '^sensor\.ai_suggester_.*_suggestions$') 
        | map(attribute='entity_id') | first | default('none') %}
      
      {% if suggestions_sensor != 'none' %}
        {% set provider = state_attr(suggestions_sensor, 'provider') %}
        # ü§ñ AI Status: {{ provider }}
        **Antal forslag:** {{ states(suggestions_sensor) }}
        **Scannede enheder:** {{ state_attr(suggestions_sensor, 'entities_processed_count') }}
        
        ---
        ### üí° Seneste Forslag
        {% set suggestions = state_attr(suggestions_sensor, 'suggestions_list') %}
        {% if suggestions %}
          **{{ suggestions[0].title }}**
          {{ suggestions[0].description }}
        {% else %}
          _Ingen aktive forslag lige nu._
        {% endif %}
      {% else %}
        # ‚ö†Ô∏è Ingen AI fundet
        V√¶r sikker p√• at du har konfigureret en AI-udbyder i integrationen.
      {% endif %}

  # --- 3. SYSTEM KONTROL (Universel) ---
  - type: entities
    title: "AI Kontrolpanel"
    show_header_toggle: false
    entities:
      # Her lister vi alle fundne AI-status sensorer automatisk
      - type: custom:auto-entities
        card:
          type: section
          label: "Forbindelses Status"
        filter:
          include:
            - entity_id: "sensor.ai_suggester_*_status"
        show_empty: false

    footer:
      type: buttons
      entities:
        - action_name: "Start Analyse"
          service: ai_automation_suggester.generate_suggestions
          icon: mdi:refresh
          # Vi lader service_data v√¶re tom, s√• tager den 'default' AI
          service_data: {}
        - action_name: "Ryd Historik"
          service: ai_automation_suggester.clear_suggestion_history
          icon: mdi:delete-sweep

  # --- 4. AVANCERET DIAGNOSTIK (Auto-list) ---
  - type: custom:auto-entities
    card:
      type: entities
      title: "AI Diagnostik"
    filter:
      include:
        - entity_id: "sensor.ai_suggester_*_model"
        - entity_id: "sensor.ai_suggester_*_last_error"
        - entity_id: "sensor.ai_suggester_*_input_tokens"
